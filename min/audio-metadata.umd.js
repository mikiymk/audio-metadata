(function(f,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(f=typeof globalThis<"u"?globalThis:f||self,p(f.AudioMetadata={}))})(this,function(f){"use strict";const p=t=>{let e;if(ArrayBuffer.isView(t))e=new DataView(t.buffer,t.byteOffset,t.byteLength);else if(t instanceof ArrayBuffer||t instanceof SharedArrayBuffer)e=new DataView(t);else throw new Error("Expected instance of TypedArray, DataView or ArrayBuffer");return{view:e,position:0}},i=(t,e)=>{const n=t.position,o=t.view;return t.position+=e,{view:o,position:n}},v=(t,e)=>{const n=t.position,o=t.view;return t.position=e<0?o.byteLength+e:e,{view:o,position:n}},x=t=>t.view.byteLength-t.position,s=(t,e,n=!1)=>{const{view:o,position:r}=i(t,e);return Number(o[{1:"getUint8",2:"getUint16",4:"getUint32",8:"getBigUint64"}[e]](r,n))},D=(t,e)=>{const{view:n,position:o}=i(t,e);return n.buffer.slice(o,o+e)},m="ascii",L="utf-8",T="utf-16be",g="utf-16le",a=(t,e,n=L)=>new TextDecoder(n).decode(D(t,e)),S=(t,e)=>new Uint8Array(D(t,e)),b=(t,e)=>p(D(t,e)),E=(t,e=0)=>(...n)=>{const[{view:o,position:r},...c]=n;return t({view:o,position:r+e},...c)},d=t=>t.replace(/\0+$/,""),F=(t,e)=>{const n=t.indexOf(e);return[t.substring(0,n),t.substring(n+1)]},M=t=>{if(x(t)<27)return;const e=(i(t,26),s(t,1)),n=S(t,e);if(!n.length)return;const o=n.reduce((r,c)=>r+c);return i(t,7),{pageSize:o+27+e,packet:b(t,o-7)}},G=t=>{try{const e=s(t,4,!0),n=(i(t,e),s(t,4,!0)),o={},r={tracknumber:"track"};for(let c=0;c<n;c++){const l=s(t,4,!0),u=a(t,l),[y,A]=F(u,"="),C=y.toLowerCase();o[r[C]||C]=o[C]=d(A)}return o}catch{return}},H=t=>{const e=p(t);if(!M(e))return;const o=M(e);if(o)return G(o.packet)},O=t=>(v(t,-128),a(t,3,m)==="TAG"),j=t=>{const e=p(t);try{if(!O(e))return;const n=E(s,122)(e,1)===0;return{title:d(a(e,30,m)),artist:d(a(e,30,m)),album:d(a(e,30,m)),year:d(a(e,4,m)),comment:d(a(e,n?28:30,m)),track:n?s(e,2):void 0,genre:s(e,1)}}catch{return}},k=t=>S(t,4).reduce((e,n)=>e<<7|n&127,0),R=(t,e)=>{var n;return a(t,e-1,(n={0:m,1:E(s)(t,2)===65279?T:g,2:T}[s(t,1)])!=null?n:L)},N={TALB:"album",TCOM:"composer",TIT1:"title",TIT2:"title",TPE1:"artist",TRCK:"track",TSSE:"encoder",TDRC:"year",TCON:"genre"},X=t=>{try{const e=a(t,4,m),n=k(t);i(t,2);const o=e[0]==="T"?d(R(t,n)):(i(t,n),void 0);return{id:e,content:o}}catch{return}},K=t=>{const e=p(t);if(a(e,3,m)!=="ID3")return;const n=(i(e,2),s(e,1)),o=k(e),r=!!(n&128),c={},l=r?k(e):0;for(i(e,l);e.position<10+l+o;){const u=X(e);if(!u)break;if(!u.content)continue;const y=N[u.id]||u.id;if(y==="TXXX"){const[A,C]=F(u.content,"\0");c[A]=C}else c[y]=c[u.id]=u.content}return c},W=t=>{const e=p(t);if(a(e,4,m)!=="fLaC")return;let n=!1,o={};for(;!n;){const r=s(e,1),c=s(e,2)*2**8+s(e,1);n=r>127,(r&127)==4?o={...o,...G(b(e,c))}:i(e,c)}return o},_=t=>"G"+S(t,16).reduce((e,n)=>e+n.toString(16).padStart(2,"0").toUpperCase(),""),B=t=>{try{const e=_(t),n=s(t,8,!0),o=b(t,n-24);return{guid:e,size:n,data:o}}catch{return}},$=t=>{const e=s(t,2,!0),n=s(t,2,!0),o=s(t,2,!0),r=s(t,2,!0),c=s(t,2,!0);return{title:d(a(t,e,g)),artist:d(a(t,n,g)),copyright:d(a(t,o,g)),comment:d(a(t,r,g)),rating:d(a(t,c,g))}},I={"wm/albumtitle":"album"},q=t=>{const e={},n=s(t,2,!0);for(let o=0;o<n;o++){const r=s(t,2,!0),c=d(a(t,r,g)).toLowerCase(),l=c.startsWith("wm/")?c.slice(3):c,u=I[c]||c,y=s(t,2,!0),A=s(t,2,!0);switch(y){case 0:e[l]=e[u]=d(a(t,A,g));break;default:i(t,A)}}return e},J=t=>{var o;i(t,22);let e={},n;for(;n=B(t);){const r={GEACBF8C5AF5B48778467AA8C44FA4CCA:V,G941C23449894D149A1411D134E457054:V};e={...e,...(o=r[n.guid])==null?void 0:o.call(r,n.data)}}return e},V=t=>{const e={},n=s(t,2,!0);for(let o=0;o<n;o++){i(t,4);const r=s(t,2,!0),c=s(t,2,!0),l=s(t,2,!0),u=d(a(t,r,g)).toLowerCase(),y=u.startsWith("wm/")?u.slice(3):u,A=I[u]||u;switch(c){case 0:e[y]=e[A]=d(a(t,l,g));break;default:i(t,l)}}return e},P=t=>{var n;const e=p(t);try{const o=B(e);if(!o||o.guid!=="G3026B2758E66CF11A6D900AA0062CE6C")return;i(o.data,6);let r,c={};for(;r=B(o.data);){const l={G3326B2758E66CF11A6D900AA0062CE6C:$,G40A4D0D207E3D21197F000A0C95EA850:q,GB503BF5F2EA9CF118EE300C00C205365:J};c={...c,...(n=l[r.guid])==null?void 0:n.call(l,r.data)}}return c}catch{return}},Q=t=>{try{const e=s(t,4),n=a(t,4,m).toLowerCase(),o=e===1?s(t,8):e||x(t);return{size:o,type:n,data:b(t,o-(e===1?16:8))}}catch{return}},U=function*(t){let e,n=0;for(;(e=Q(t))&&!(n++>100);)yield e},Y={"\xA9alb":"album","\xA9wrt":"composer","\xA9nam":"title","\xA9art":"artist",aart:"albumartist","\xA9cmt":"comment",trkn:"track","\xA9too":"encoder","\xA9day":"year","\xA9gen":"genre",gnre:"genre"},Z=t=>{const e=[...U(t)].find(n=>n.type==="data");if(e){const n=e.data,o=s(n,4);i(n,4);const r={1:L,2:T,4:L,5:T}[o];return r&&a(n,x(n),r)}},w=t=>{let e={};for(const{data:n,type:o}of U(t)){const r=Z(n);r&&(e={...e,[o]:r,[Y[o]||o]:r})}return e},h=t=>{var n;let e={};for(const{type:o,data:r}of U(t))e={...e,...(n=z[o])==null?void 0:n.call(z,r)};return e},z={moov:h,trak:h,mdia:h,udta:h,meta:t=>h(tt(t)),ilst:w},tt=t=>{const e=E(a,4)(t,4,m),n=E(a,16)(t,4,m);return e==="hdlr"&&n==="mdta"||i(t,4),t},et=t=>{const e=p(t),n=h(e);return Object.keys(n).length===0?void 0:n};f.flac=W,f.id3v1=j,f.id3v2=K,f.mp4=et,f.ogg=H,f.wma=P,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

(function(f,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(f=typeof globalThis<"u"?globalThis:f||self,g(f.AudioMetadata={}))})(this,function(f){"use strict";const g=t=>{let e;if(ArrayBuffer.isView(t))e=new DataView(t.buffer,t.byteOffset,t.byteLength);else if(t instanceof ArrayBuffer||t instanceof SharedArrayBuffer)e=new DataView(t);else throw new Error("Expected instance of TypedArray, DataView or ArrayBuffer");return[e,0]},i=(t,e)=>{const[n,r]=t;return t[1]+=e,[n,r]},H=(t,e)=>{const[n,r]=t;return t[1]=e<0?n.byteLength+e:e,[n,r]},x=([t,e])=>t.byteLength-e,s=(t,e,n=!1)=>{const[r,o]=i(t,e);return Number(r[{1:"getUint8",2:"getUint16",4:"getUint32",8:"getBigUint64"}[e]](o,n))},D=(t,e)=>{const[n,r]=i(t,e);return n.buffer.slice(r,r+e)},m="ascii",L="utf-8",T="utf-16be",p="utf-16le",a=(t,e,n=L)=>new TextDecoder(n).decode(D(t,e)),S=(t,e)=>new Uint8Array(D(t,e)),b=(t,e)=>g(D(t,e)),E=(t,e=0)=>(...n)=>{const[[r,o],...c]=n;return t([r,o+e],...c)},d=t=>t.replace(/\0+$/,""),F=(t,e)=>{const n=t.indexOf(e);return[t.substring(0,n),t.substring(n+1)]},M=t=>{if(x(t)<27)return;const e=(i(t,26),s(t,1)),n=S(t,e);if(!n.length)return;const r=n.reduce((o,c)=>o+c);return i(t,7),{pageSize:r+27+e,packet:b(t,r-7)}},G=t=>{try{const e=s(t,4,!0),n=(i(t,e),s(t,4,!0)),r={},o={tracknumber:"track"};for(let c=0;c<n;c++){const l=s(t,4,!0),u=a(t,l),[y,A]=F(u,"="),C=y.toLowerCase();r[o[C]||C]=r[C]=d(A)}return r}catch{return}},O=t=>{const e=g(t);if(!M(e))return;const r=M(e);if(r)return G(r.packet)},j=t=>(H(t,-128),a(t,3,m)==="TAG"),R=t=>{const e=g(t);try{if(!j(e))return;const n=E(s,122)(e,1)===0;return{title:d(a(e,30,m)),artist:d(a(e,30,m)),album:d(a(e,30,m)),year:d(a(e,4,m)),comment:d(a(e,n?28:30,m)),track:n?s(e,2):void 0,genre:s(e,1)}}catch{return}},k=t=>S(t,4).reduce((e,n)=>e<<7|n&127,0),N=(t,e)=>{var n;return a(t,e-1,(n={0:m,1:E(s)(t,2)===65279?T:p,2:T}[s(t,1)])!=null?n:L)},X={TALB:"album",TCOM:"composer",TIT1:"title",TIT2:"title",TPE1:"artist",TRCK:"track",TSSE:"encoder",TDRC:"year",TCON:"genre"},v=t=>{try{const e=a(t,4,m),n=k(t);i(t,2);const r=e[0]==="T"?d(N(t,n)):(i(t,n),void 0);return{id:e,content:r}}catch{return}},K=t=>{const e=g(t);if(a(e,3,m)!=="ID3")return;const n=(i(e,2),s(e,1)),r=k(e),o=!!(n&128),c={},l=o?k(e):0;for(i(e,l);e[1]<10+l+r;){const u=v(e);if(!u)break;if(!u.content)continue;const y=X[u.id]||u.id;if(y==="TXXX"){const[A,C]=F(u.content,"\0");c[A]=C}else c[y]=c[u.id]=u.content}return c},W=t=>{const e=g(t);if(a(e,4,m)!=="fLaC")return;let n=!1,r={};for(;!n;){const o=s(e,1),c=s(e,2)*2**8+s(e,1);n=o>127,(o&127)==4?r={...r,...G(b(e,c))}:i(e,c)}return r},_=t=>"G"+S(t,16).reduce((e,n)=>e+n.toString(16).padStart(2,"0").toUpperCase(),""),B=t=>{try{const e=_(t),n=s(t,8,!0),r=b(t,n-24);return{guid:e,size:n,data:r}}catch{return}},$=t=>{const e=s(t,2,!0),n=s(t,2,!0),r=s(t,2,!0),o=s(t,2,!0),c=s(t,2,!0);return{title:d(a(t,e,p)),artist:d(a(t,n,p)),copyright:d(a(t,r,p)),comment:d(a(t,o,p)),rating:d(a(t,c,p))}},I={"wm/albumtitle":"album"},q=t=>{const e={},n=s(t,2,!0);for(let r=0;r<n;r++){const o=s(t,2,!0),c=d(a(t,o,p)).toLowerCase(),l=c.startsWith("wm/")?c.slice(3):c,u=I[c]||c,y=s(t,2,!0),A=s(t,2,!0);switch(y){case 0:e[l]=e[u]=d(a(t,A,p));break;default:i(t,A)}}return e},J=t=>{var r;i(t,22);let e={},n;for(;n=B(t);){const o={GEACBF8C5AF5B48778467AA8C44FA4CCA:V,G941C23449894D149A1411D134E457054:V};e={...e,...(r=o[n.guid])==null?void 0:r.call(o,n.data)}}return e},V=t=>{const e={},n=s(t,2,!0);for(let r=0;r<n;r++){i(t,4);const o=s(t,2,!0),c=s(t,2,!0),l=s(t,2,!0),u=d(a(t,o,p)).toLowerCase(),y=u.startsWith("wm/")?u.slice(3):u,A=I[u]||u;switch(c){case 0:e[y]=e[A]=d(a(t,l,p));break;default:i(t,l)}}return e},P=t=>{var n;const e=g(t);try{const r=B(e);if(!r||r.guid!=="G3026B2758E66CF11A6D900AA0062CE6C")return;i(r.data,6);let o,c={};for(;o=B(r.data);){const l={G3326B2758E66CF11A6D900AA0062CE6C:$,G40A4D0D207E3D21197F000A0C95EA850:q,GB503BF5F2EA9CF118EE300C00C205365:J};c={...c,...(n=l[o.guid])==null?void 0:n.call(l,o.data)}}return c}catch{return}},Q=t=>{try{const e=s(t,4),n=a(t,4,m).toLowerCase(),r=e===1?s(t,8):e||x(t);return{size:r,type:n,data:b(t,r-(e===1?16:8))}}catch{return}},U=function*(t){let e,n=0;for(;(e=Q(t))&&!(n++>100);)yield e},Y={"\xA9alb":"album","\xA9wrt":"composer","\xA9nam":"title","\xA9art":"artist",aart:"albumartist","\xA9cmt":"comment",trkn:"track","\xA9too":"encoder","\xA9day":"year","\xA9gen":"genre",gnre:"genre"},Z=t=>{const e=[...U(t)].find(n=>n.type==="data");if(e){const n=e.data,r=s(n,4);i(n,4);const o={1:L,2:T,4:L,5:T}[r];return o&&a(n,x(n),o)}},w=t=>{let e={};for(const{data:n,type:r}of U(t)){const o=Z(n);o&&(e={...e,[r]:o,[Y[r]||r]:o})}return e},h=t=>{var n;let e={};for(const{type:r,data:o}of U(t))e={...e,...(n=z[r])==null?void 0:n.call(z,o)};return e},z={moov:h,trak:h,mdia:h,udta:h,meta:t=>h(tt(t)),ilst:w},tt=t=>{const e=E(a,4)(t,4,m),n=E(a,16)(t,4,m);return e==="hdlr"&&n==="mdta"||i(t,4),t},et=t=>{const e=g(t),n=h(e);return Object.keys(n).length===0?void 0:n};f.flac=W,f.id3v1=R,f.id3v2=K,f.mp4=et,f.ogg=O,f.wma=P,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

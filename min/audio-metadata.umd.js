(function(g,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(g=typeof globalThis<"u"?globalThis:g||self,u(g.AudioMetadata={}))})(this,function(g){"use strict";const u=e=>e.replace(/\0+$/,""),T=(e,t)=>{const n=e.indexOf(t);return[e.substring(0,n),e.substring(n+1)]},U=e=>{if(e instanceof Uint8Array&&(e=e.buffer.slice(0)),!(e instanceof ArrayBuffer))throw new Error("Expected instance of Buffer or ArrayBuffer");return new DataView(e)},C=(e,t,n)=>new Uint8Array(e.buffer).slice(t,t+n),h=e=>(t,n,r)=>new TextDecoder(e).decode(t.buffer.slice(n,n+r)),d=h("ascii"),L=h(),D=h("utf-16be"),p=h("utf-16le"),E=(e,t)=>{if(e.byteLength<t+27)return;const n=e.getUint8(t+26),r=C(e,t+27,n),c=27+n;if(!r.length)return;const i=c+r.reduce((o,s)=>o+s),a=c+7;return{pageSize:i,packet:U(C(e,t+a,i-a))}},k=e=>{try{const t=e.getUint32(0,!0),n=e.getUint32(4+t,!0),r={},c={tracknumber:"track"};for(let i=0,a=8+t;i<n;i++){const o=e.getUint32(a,!0),s=L(e,a+4,o),[l,m]=T(s,"="),b=l.toLowerCase();r[c[b]||b]=r[b]=u(m),a+=4+o}return r}catch{return}},S=e=>{const t=U(e),n=E(t,0);if(!n)return;const r=E(t,n.pageSize);if(r)return k(r.packet)},F=e=>d(e,e.byteLength-128,3)==="TAG",M=e=>{const t=U(e);try{if(!F(t))return;const n=t.byteLength-128,r=t.getUint8(n+125)===0,c=u(d(t,n+3,30)),i=u(d(t,n+33,30)),a=u(d(t,n+63,30)),o=u(d(t,n+93,4)),s=u(d(t,n+97,r?28:30)),l=r?t.getUint8(n+126):void 0,m=t.getUint8(n+127);return{title:c,artist:i,album:a,year:o,comment:s,track:l,genre:m}}catch{return}},y=(e,t)=>C(e,t,4).reduce((n,r)=>n<<7|r&268435455,0),$=e=>{switch(e){case 1:return(t,n,r)=>t.getUint16(n)===65279?D(t,n,r):h("utf16le")(t,n,r);case 2:return h("utf16be");case 3:return L;case 0:default:return d}},O={TALB:"album",TCOM:"composer",TIT1:"title",TIT2:"title",TPE1:"artist",TRCK:"track",TSSE:"encoder",TDRC:"year",TCON:"genre"},x=(e,t)=>{try{const n=d(e,t,4),r=10+y(e,t+4),c=n[0]==="T"?u($(e.getUint8(t+9))(e,t+11,r-11)):void 0;return{id:n,size:r,content:c}}catch{return}},z=e=>{const t=U(e);if(d(t,0,3)!=="ID3")return;const n=t.getUint8(5),r=y(t,6),c=!!(n&128),i={},a=c?y(t,10):0;for(let o=10+a;o<10+a+r;){const s=x(t,o);if(!s)break;if(o+=s.size,!s.content)continue;const l=O[s.id]||s.id;if(l==="TXXX"){const[m,b]=T(s.content,"\0");i[m]=b}else i[l]=i[s.id]=s.content}return i},j=e=>d(e,0,4)==="fLaC",H=e=>{const t=U(e);if(!j(t))return;let n=4,r=!1,c={};for(;!r;){const i=t.getUint8(n),a=t.getUint16(n+1)*2**16+t.getUint8(n+3);r=i>127,(i&127)==4&&(c=Object.assign(c,k(U(C(t,n+4,a))))),n+=4+a}return c},A=(e,t)=>{let n="";for(let r=0;r<2;r++)n+=e.getBigUint64(t+r*8).toString(16).padStart(16,"0").toUpperCase();return n},I=(e,t)=>{const n=e.getUint16(t,!0),r=e.getUint16(t+2,!0),c=e.getUint16(t+4,!0),i=e.getUint16(t+6,!0),a=e.getUint16(t+8,!0);return{title:p(e,t+=10,n).replace(/\0$/,""),artist:p(e,t+=n,r).replace(/\0$/,""),copyright:p(e,t+=r,c).replace(/\0$/,""),comment:p(e,t+=c,i).replace(/\0$/,""),rating:p(e,t+=i,a).replace(/\0$/,"")}},B={"wm/albumtitle":"album"},N=(e,t)=>{const n={},r=e.getUint16(t,!0);t+=2;for(let c=0;c<r;c++){const i=e.getUint16(t,!0),a=p(e,t+=2,i).replace(/\0$/,"").toLowerCase(),o=a.startsWith("wm/")?a.slice(3):a,s=B[a]||a,l=e.getUint16(t+=i,!0),m=e.getUint16(t+=2,!0);switch(l){case 0:n[o]=n[s]=p(e,t+=2,m).replace(/\0$/,"");break}t+=m}return n},P=(e,t)=>{const n=e.getUint32(t+18),r={};for(t+=22;t<n;){switch(A(e,t)){case"EACBF8C5AF5B48778467AA8C44FA4CCA":case"941C23449894D149A1411D134E457054":Object.assign(r,X(e,t+24));break}t+=Number(e.getBigUint64(t+16,!0))}return r},X=(e,t)=>{const n={},r=e.getUint16(t,!0);t+=2;for(let c=0;c<r;c++){t+=4;const i=e.getUint16(t,!0),a=e.getUint16(t+=2,!0),o=e.getUint16(t+=2,!0),s=p(e,t+=2,i).replace(/\0$/,"").toLowerCase(),l=s.startsWith("wm/")?s.slice(3):s,m=B[s]||s;switch(a){case 0:n[l]=n[m]=p(e,t+=i,o).replace(/\0$/,"");break}t+=o}return n},K=e=>{const t=U(e);if(A(t,0)==="3026B2758E66CF11A6D900AA0062CE6C")try{const n=t.getBigUint64(16,!0),r={};let c=30;for(;c<n;){switch(A(t,c)){case"3326B2758E66CF11A6D900AA0062CE6C":Object.assign(r,I(t,c+24));break;case"40A4D0D207E3D21197F000A0C95EA850":Object.assign(r,N(t,c+24));break;case"B503BF5F2EA9CF118EE300C00C205365":Object.assign(r,P(t,c+24));break;default:}c+=Number(t.getBigUint64(c+16,!0))}return r}catch{return}};g.flac=H,g.id3v1=M,g.id3v2=z,g.ogg=S,g.wma=K,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
